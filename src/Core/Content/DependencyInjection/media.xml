<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">
    <parameters>
        <parameter type="collection" key="laser.media.metadata.types">
            <parameter type="string">\Laser\Core\Content\Media\Metadata\Type\ImageMetadata</parameter>
            <parameter type="string">\Laser\Core\Content\Media\Metadata\Type\DocumentMetadata</parameter>
            <parameter type="string">\Laser\Core\Content\Media\Metadata\Type\VideoMetadata</parameter>
        </parameter>
    </parameters>
    <services>
        <!-- Entity definitions -->
        <service id="Laser\Core\Content\Media\MediaDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaDefaultFolder\MediaDefaultFolderDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaThumbnail\MediaThumbnailDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaTranslation\MediaTranslationDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaFolder\MediaFolderDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaThumbnailSize\MediaThumbnailSizeDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaFolderConfiguration\MediaFolderConfigurationDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaFolderConfigurationMediaThumbnailSize\MediaFolderConfigurationMediaThumbnailSizeDefinition">
            <tag name="laser.entity.definition"/>
        </service>

        <service id="Laser\Core\Content\Media\Aggregate\MediaTag\MediaTagDefinition">
            <tag name="laser.entity.definition"/>
        </service>
        <!-- end of Entity definitions -->

        <!-- message handlers -->
        <service id="Laser\Core\Content\Media\Message\GenerateThumbnailsHandler">
            <argument type="service" id="Laser\Core\Content\Media\Thumbnail\ThumbnailService"/>
            <argument type="service" id="media.repository"/>

            <tag name="messenger.message_handler"/>
        </service>

        <service id="Laser\Core\Content\Media\Message\DeleteFileHandler">
            <argument type="service" id="laser.filesystem.public"/>
            <argument type="service" id="laser.filesystem.private"/>

            <tag name="messenger.message_handler"/>
        </service>
        <!-- end of message handlers -->

        <service id="Laser\Core\Content\Media\Subscriber\MediaLoadedSubscriber">
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <tag name="kernel.event_subscriber"/>
        </service>

        <service id="Laser\Core\Content\Media\Subscriber\MediaFolderConfigLoadedSubscriber">
            <tag name="kernel.event_subscriber"/>
        </service>

        <!--File Services-->
        <service id="Laser\Core\Content\Media\File\FileFetcher">
            <argument type="service" id="Laser\Core\Content\Media\File\FileUrlValidatorInterface" />
            <argument>%laser.media.enable_url_upload_feature%</argument>
            <argument>%laser.media.enable_url_validation%</argument>
            <argument>%laser.media.url_upload_max_size%</argument>
        </service>

        <service class="Laser\Core\Content\Media\File\FileUrlValidator" id="Laser\Core\Content\Media\File\FileUrlValidatorInterface">
        </service>

        <service id="Laser\Core\Content\Media\File\FileSaver" public="true">
            <argument type="service" id="media.repository"/>
            <argument type="service" id="laser.filesystem.public"/>
            <argument type="service" id="laser.filesystem.private"/>
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <argument type="service" id="Laser\Core\Content\Media\Thumbnail\ThumbnailService"/>
            <argument type="service" id="Laser\Core\Content\Media\Metadata\MetadataLoader"/>
            <argument type="service" id="Laser\Core\Content\Media\TypeDetector\TypeDetector"/>
            <argument type="service" id="messenger.bus.laser" />
            <argument type="service" id="event_dispatcher" />
            <argument>%laser.filesystem.allowed_extensions%</argument>
            <argument>%laser.filesystem.private_allowed_extensions%</argument>
        </service>

        <service id="Laser\Core\Content\Media\File\FileLoader">
            <argument type="service" id="laser.filesystem.public"/>
            <argument type="service" id="laser.filesystem.private"/>
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <argument type="service" id="media.repository"/>
            <argument type="service" id="Nyholm\Psr7\Factory\Psr17Factory"/>
        </service>

        <service id="Laser\Core\Content\Media\File\FileNameProvider" class="Laser\Core\Content\Media\File\WindowsStyleFileNameProvider">
            <argument type="service" id="media.repository"/>
        </service>

        <service id="Laser\Core\Content\Media\File\DownloadResponseGenerator">
            <argument type="service" id="laser.filesystem.public"/>
            <argument type="service" id="laser.filesystem.private"/>
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <argument type="service" id="Laser\Core\Content\Media\MediaService"/>
            <argument>%laser.filesystem.private_local_download_strategy%</argument>
        </service>

        <!-- Commands -->
        <service id="Laser\Core\Content\Media\Commands\GenerateThumbnailsCommand">
            <argument type="service" id="Laser\Core\Content\Media\Thumbnail\ThumbnailService"/>
            <argument type="service" id="media.repository"/>
            <argument type="service" id="media_folder.repository"/>
            <argument type="service" id="messenger.bus.laser"/>

            <tag name="console.command"/>
        </service>

        <service id="Laser\Core\Content\Media\Commands\GenerateMediaTypesCommand">
            <argument type="service" id="Laser\Core\Content\Media\TypeDetector\TypeDetector"/>
            <argument type="service" id="media.repository"/>

            <tag name="console.command"/>
        </service>

        <service id="Laser\Core\Content\Media\Commands\DeleteNotUsedMediaCommand">
            <argument type="service" id="Laser\Core\Content\Media\DeleteNotUsedMediaService"/>

            <tag name="console.command"/>
        </service>

        <!-- Pathname -->
        <service class="Laser\Core\Content\Media\Pathname\UrlGenerator" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface">
            <argument type="service" id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PathnameStrategyInterface"/>
            <argument type="service" id="laser.filesystem.public"/>

            <tag name="kernel.reset" method="reset"/>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\StrategyFactory">
            <argument type="tagged" tag="laser.pathname.strategy"/>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PathnameStrategyInterface">
            <factory service="Laser\Core\Content\Media\Pathname\PathnameStrategy\StrategyFactory" method="factory"/>
            <argument>%laser.cdn.strategy%</argument>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\FilenamePathnameStrategy">
            <argument type="service" id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PlainPathnameStrategy"/>

            <tag name="laser.pathname.strategy"/>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PhysicalFilenamePathnameStrategy">
            <argument type="service" id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PlainPathnameStrategy"/>

            <tag name="laser.pathname.strategy"/>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PlainPathnameStrategy">
            <tag name="laser.pathname.strategy"/>
        </service>

        <service id="Laser\Core\Content\Media\Pathname\PathnameStrategy\IdPathnameStrategy">
            <argument type="service" id="Laser\Core\Content\Media\Pathname\PathnameStrategy\PlainPathnameStrategy"/>

            <tag name="laser.pathname.strategy"/>
        </service>

        <!-- Controller -->
        <service id="Laser\Core\Content\Media\Api\MediaUploadController" public="true">
            <argument type="service" id="Laser\Core\Content\Media\MediaService"/>
            <argument type="service" id="Laser\Core\Content\Media\File\FileSaver"/>
            <argument type="service" id="Laser\Core\Content\Media\File\FileNameProvider"/>
            <argument type="service" id="Laser\Core\Content\Media\MediaDefinition"/>
            <argument type="service" id="event_dispatcher"/>

            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <service id="Laser\Core\Content\Media\Api\MediaFolderController" public="true">
            <argument type="service" id="Laser\Core\Content\Media\MediaFolderService"/>
            <call method="setContainer">
                <argument type="service" id="service_container"/>
            </call>
        </service>

        <!-- Metadata -->
        <service id="Laser\Core\Content\Media\Metadata\MetadataLoader\ImageMetadataLoader">
            <tag name="laser.metadata.loader"/>
        </service>

        <service id="Laser\Core\Content\Media\Metadata\MetadataLoader">
            <argument type="tagged" tag="laser.metadata.loader"/>
        </service>

        <!-- TypeDetector -->
        <service id="Laser\Core\Content\Media\TypeDetector\AudioTypeDetector">
            <tag name="laser.media_type.detector" priority="10"/>
        </service>

        <service id="Laser\Core\Content\Media\TypeDetector\DefaultTypeDetector">
            <tag name="laser.media_type.detector" priority="0"/>
        </service>

        <service id="Laser\Core\Content\Media\TypeDetector\DocumentTypeDetector">
            <tag name="laser.media_type.detector" priority="10"/>
        </service>

        <service id="Laser\Core\Content\Media\TypeDetector\ImageTypeDetector">
            <tag name="laser.media_type.detector" priority="10"/>
        </service>

        <service id="Laser\Core\Content\Media\TypeDetector\VideoTypeDetector">
            <tag name="laser.media_type.detector" priority="10"/>
        </service>

        <service id="Laser\Core\Content\Media\TypeDetector\TypeDetector">
            <argument type="tagged" tag="laser.media_type.detector"/>
        </service>

        <!-- Services -->
        <service id="Laser\Core\Content\Media\DeleteNotUsedMediaService">
            <argument type="service" id="media.repository"/>
            <argument type="service" id="media_default_folder.repository"/>
        </service>

        <service id="Laser\Core\Content\Media\MediaFolderService">
            <argument type="service" id="media.repository"/>
            <argument type="service" id="media_folder.repository"/>
            <argument type="service" id="media_folder_configuration.repository"/>
        </service>

        <service id="Laser\Core\Content\Media\Thumbnail\ThumbnailService">
            <argument type="service" id="media_thumbnail.repository"/>
            <argument type="service" id="laser.filesystem.public"/>
            <argument type="service" id="laser.filesystem.private"/>
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <argument type="service" id="media_folder.repository"/>
        </service>

        <service id="Laser\Core\Content\Media\MediaService">
            <argument type="service" id="media.repository"/>
            <argument type="service" id="media_folder.repository"/>
            <argument type="service" id="Laser\Core\Content\Media\File\FileLoader"/>
            <argument type="service" id="Laser\Core\Content\Media\File\FileSaver"/>
            <argument type="service" id="Laser\Core\Content\Media\File\FileFetcher"/>
        </service>

        <service id="Laser\Core\Content\Media\Cms\DefaultMediaResolver">
            <argument type="service" id="laser.filesystem.public"/>
        </service>

        <service id="Laser\Core\Content\Media\Cms\ImageCmsElementResolver">
            <tag name="laser.cms.data_resolver" />
            <argument type="service" id="Laser\Core\Content\Media\Cms\DefaultMediaResolver"/>
        </service>

        <service id="Laser\Core\Content\Media\Cms\Type\ImageSliderTypeDataResolver">
            <tag name="laser.cms.data_resolver" />
            <argument type="service" id="Laser\Core\Content\Media\Cms\DefaultMediaResolver"/>
        </service>

        <service id="Laser\Core\Content\Media\Cms\Type\ImageGalleryTypeDataResolver">
            <tag name="laser.cms.data_resolver" />
            <argument type="service" id="Laser\Core\Content\Media\Cms\DefaultMediaResolver"/>
        </service>

        <service id="Laser\Core\Content\Media\Cms\YoutubeVideoCmsElementResolver">
            <tag name="laser.cms.data_resolver" />
        </service>

        <service id="Laser\Core\Content\Media\Cms\VimeoVideoCmsElementResolver">
            <tag name="laser.cms.data_resolver" />
        </service>

        <service id="Laser\Core\Content\Media\DataAbstractionLayer\MediaIndexer">
            <tag name="laser.entity_indexer"/>
            <argument type="service" id="Laser\Core\Framework\DataAbstractionLayer\Dbal\Common\IteratorFactory"/>
            <argument type="service" id="media.repository"/>
            <argument type="service" id="media_thumbnail.repository"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="event_dispatcher"/>
        </service>

        <service id="Laser\Core\Content\Media\DataAbstractionLayer\MediaFolderConfigurationIndexer">
            <tag name="laser.entity_indexer"/>
            <argument type="service" id="Laser\Core\Framework\DataAbstractionLayer\Dbal\Common\IteratorFactory"/>
            <argument type="service" id="media_folder_configuration.repository"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="event_dispatcher"/>
        </service>

        <service id="Laser\Core\Content\Media\DataAbstractionLayer\MediaFolderIndexer">
            <argument type="service" id="Laser\Core\Framework\DataAbstractionLayer\Dbal\Common\IteratorFactory"/>
            <argument type="service" id="media_folder.repository"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="event_dispatcher"/>
            <argument type="service" id="Laser\Core\Framework\DataAbstractionLayer\Indexing\ChildCountUpdater"/>
            <argument type="service" id="Laser\Core\Framework\DataAbstractionLayer\Indexing\TreeUpdater"/>

            <tag name="laser.entity_indexer"/>
        </service>

        <service id="Laser\Core\Content\Media\Subscriber\MediaDeletionSubscriber">
            <tag name="kernel.event_subscriber"/>
            <argument type="service" id="Laser\Core\Content\Media\Pathname\UrlGeneratorInterface"/>
            <argument type="service" id="event_dispatcher"/>
            <argument type="service" id="media_thumbnail.repository"/>
            <argument type="service" id="messenger.bus.laser"/>
            <argument type="service" id="Laser\Core\Content\Media\Message\DeleteFileHandler"/>
            <argument type="service" id="Doctrine\DBAL\Connection"/>
            <argument type="service" id="media.repository"/>
        </service>
    </services>
</container>
